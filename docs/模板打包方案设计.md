# 模板打包方案设计

## 一、需求分析

### 1.1 模板包含的核心内容

用户需求：将以下内容打包成一个模板
1. **Excel表格**（技术规格表格，19行左右）- 后端输入
2. **产品应用类型图片**（多个应用场景图片）
3. **工厂图片**（多张工厂实拍图）
4. **铝型材的工艺处理描述**（详细的工艺说明）

---

## 二、当前系统状态分析

### 2.1 已有支持

#### ✅ Excel表格（技术规格）
**现状**：
- 已有 `TemplateSpecification` 模型存储规格数据
- 已有 `TemplateSpecificationInline` 支持内联编辑
- 已有 `ExcelTableWidget` 用于产品表单（但模板未使用）

**问题**：
- ❌ 模板规格只能逐条手动添加（内联编辑）
- ❌ 不支持Excel文件导入批量添加

#### ✅ 产品应用类型图片
**现状**：
- 已有 `TemplateApplication` 模型
- 支持图片上传（`image`字段）
- 已有 `TemplateApplicationInline` 支持内联编辑

**状态**：✅ 已完全支持

#### ✅ 工厂图片
**现状**：
- 已有 `TemplateFactoryImage` 模型
- 支持图片上传（`image`字段）
- 支持分类（`category`字段：factory, production, quality等）
- 已有 `TemplateFactoryImageInline` 支持内联编辑

**状态**：✅ 已完全支持

#### ⚠️ 工艺处理描述
**现状**：
- 已有 `surface_treatment` 字段（简短描述）
- 格式：`'Mill Finished, Anodized, Powder Coated, Electrohoresis, Wood Grain'`
- ❌ 缺少详细的工艺处理描述字段

**问题**：
- 只有简短的关键词列表
- 没有详细的工艺说明文字
- 没有工艺图片展示

---

## 三、模板打包方案设计

### 方案一：增强现有系统（推荐）

#### 3.1 Excel表格导入功能

**实现方式**：
1. **添加Excel导入按钮**到模板规格内联编辑
2. **支持Excel文件上传**（.xlsx, .xls格式）
3. **自动解析Excel**，批量创建规格记录

**Excel格式要求**：
```
| 规格名称 (A列)     | 规格值 (B列)                    |
|-------------------|--------------------------------|
| Material & Temper | Aluminum 6063-T5/T6             |
| Surface Treatment | Mill Finished, Anodized...      |
| Colour            | Silver, White, Black...         |
| ...               | ...                            |
```

**实现步骤**：
1. 添加Excel导入按钮到 `TemplateSpecificationInline`
2. 创建导入视图函数
3. 使用 `openpyxl` 或 `pandas` 解析Excel
4. 批量创建 `TemplateSpecification` 记录

---

#### 3.2 工艺处理描述增强

**方案A：添加新字段到模板**
```python
class ProductTemplate(models.Model):
    # ... 现有字段 ...
    
    # ⭐新增：详细的工艺处理描述
    surface_treatment_detail = models.TextField(
        '工艺处理详细描述',
        blank=True,
        help_text='详细的铝型材表面处理工艺说明，可包含多段文字'
    )
    
    # ⭐新增：工艺处理图片（可选）
    surface_treatment_images = models.ManyToManyField(
        'TemplateProcessImage',
        blank=True,
        verbose_name='工艺处理图片',
        help_text='展示各种工艺处理的图片'
    )
```

**方案B：创建独立的工艺处理模型**
```python
class TemplateProcess(models.Model):
    """模板工艺处理"""
    template = models.ForeignKey(ProductTemplate, on_delete=models.CASCADE, related_name='process_items')
    name = models.CharField('工艺名称', max_length=200)  # 如：阳极氧化、粉末喷涂
    description = models.TextField('工艺描述')
    image = models.ImageField('工艺图片', upload_to='template_process/', blank=True)
    order = models.IntegerField('排序', default=0)
    
    class Meta:
        verbose_name = '模板工艺处理'
        verbose_name_plural = '模板工艺处理'
        ordering = ['order']
```

**推荐**：方案B（独立模型）
- 更灵活，可以添加多种工艺
- 每种工艺可以有图片展示
- 便于管理

---

### 3.3 模板打包结构

```
产品模板（ProductTemplate）
├─ 基本信息
│  ├─ 模板名称
│  ├─ 关联分类/子分类
│  └─ 状态
│
├─ 基础参数（文本字段）
│  ├─ Range, Type
│  ├─ Surface Treatment（简短）
│  ├─ Colors, Grade, Temper
│  └─ ...其他参数
│
├─ ⭐ Excel表格（技术规格）
│  └─ TemplateSpecification[]（多条记录）
│     ├─ 支持Excel导入批量添加
│     └─ 支持手动逐条添加
│
├─ ⭐ 工艺处理描述
│  └─ TemplateProcess[]（多条记录）
│     ├─ 工艺名称
│     ├─ 工艺描述
│     └─ 工艺图片
│
├─ ⭐ 产品应用类型图片
│  └─ TemplateApplication[]（多条记录）
│     ├─ 应用名称
│     ├─ 应用描述
│     └─ 应用场景图片
│
├─ ⭐ 工厂图片
│  └─ TemplateFactoryImage[]（多条记录）
│     ├─ 图片标题
│     ├─ 图片描述
│     ├─ 工厂图片
│     └─ 图片分类（factory/production/quality等）
│
├─ 文本内容
│  ├─ 产品描述
│  ├─ 特性文本
│  ├─ 应用文本
│  └─ 包装详情
│
└─ 商业信息
   ├─ OEM支持
   ├─ 免费样品
   ├─ 供应能力
   └─ ...
```

---

## 四、实施步骤

### 步骤1：添加工艺处理模型（必须）

**文件**：`backend/apps/products/models.py`

```python
class TemplateProcess(models.Model):
    """模板工艺处理"""
    template = models.ForeignKey(
        ProductTemplate, 
        on_delete=models.CASCADE, 
        related_name='process_items',
        verbose_name='模板'
    )
    name = models.CharField('工艺名称', max_length=200, help_text='如：阳极氧化、粉末喷涂、电泳等')
    description = models.TextField('工艺描述', help_text='详细的工艺处理说明')
    image = models.ImageField('工艺图片', upload_to='template_process/', blank=True, null=True)
    order = models.IntegerField('排序', default=0)
    created_at = models.DateTimeField('创建时间', auto_now_add=True)
    
    class Meta:
        verbose_name = '模板工艺处理'
        verbose_name_plural = '模板工艺处理'
        ordering = ['order', 'created_at']
    
    def __str__(self):
        return f"{self.template.name} - {self.name}"
```

---

### 步骤2：创建Excel导入功能（必须）

#### 2.1 安装依赖
```bash
pip install openpyxl pandas
```

#### 2.2 创建导入视图

**文件**：`backend/apps/products/admin.py`

```python
from django.http import JsonResponse
from django.urls import path
import openpyxl
from io import BytesIO

@admin.register(ProductTemplate)
class ProductTemplateAdmin(admin.ModelAdmin):
    # ... 现有代码 ...
    
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path(
                '<int:template_id>/import-specifications/',
                self.admin_site.admin_view(self.import_specifications),
                name='products_template_import_specifications',
            ),
        ]
        return custom_urls + urls
    
    def import_specifications(self, request, template_id):
        """导入Excel规格表格"""
        if request.method == 'POST':
            try:
                template = ProductTemplate.objects.get(id=template_id)
                excel_file = request.FILES.get('excel_file')
                
                if not excel_file:
                    return JsonResponse({'success': False, 'error': '请选择Excel文件'})
                
                # 读取Excel文件
                workbook = openpyxl.load_workbook(BytesIO(excel_file.read()))
                sheet = workbook.active
                
                # 解析Excel（假设第一列是规格名称，第二列是规格值）
                imported_count = 0
                for row in sheet.iter_rows(min_row=2, values_only=True):  # 跳过标题行
                    if row[0] and row[1]:  # 确保两列都有值
                        TemplateSpecification.objects.create(
                            template=template,
                            name=str(row[0]).strip(),
                            value=str(row[1]).strip(),
                            order=imported_count
                        )
                        imported_count += 1
                
                return JsonResponse({
                    'success': True,
                    'message': f'成功导入 {imported_count} 条规格记录'
                })
            except Exception as e:
                return JsonResponse({'success': False, 'error': str(e)})
        
        return JsonResponse({'success': False, 'error': '仅支持POST请求'})
```

#### 2.3 添加工艺处理内联编辑

**文件**：`backend/apps/products/admin.py`

```python
class TemplateProcessInline(admin.TabularInline):
    """模板工艺处理内联编辑"""
    model = TemplateProcess
    extra = 1
    fields = ['name', 'description', 'image', 'order']
    ordering = ['order']
```

#### 2.4 更新模板Admin

```python
@admin.register(ProductTemplate)
class ProductTemplateAdmin(admin.ModelAdmin):
    # ... 现有代码 ...
    
    inlines = [
        TemplateSpecificationInline,  # Excel表格（技术规格）
        TemplateProcessInline,  # ⭐新增：工艺处理
        TemplateFeatureInline,
        TemplateApplicationInline,  # 产品应用类型图片
        TemplateFactoryImageInline,  # 工厂图片
    ]
    
    # ⭐新增：添加Excel导入按钮到内联编辑
    def get_inline_instances(self, request, obj=None):
        inline_instances = super().get_inline_instances(request, obj)
        # 可以在内联编辑中添加导入按钮
        return inline_instances
```

---

### 步骤3：更新序列化器（必须）

**文件**：`backend/apps/products/template_serializers.py`

```python
class TemplateProcessSerializer(serializers.ModelSerializer):
    """模板工艺处理序列化器"""
    class Meta:
        model = TemplateProcess
        fields = ['id', 'name', 'description', 'image', 'order']
        read_only_fields = ['id']

class ProductTemplateSerializer(serializers.ModelSerializer):
    # ... 现有字段 ...
    
    # ⭐新增
    process_items = TemplateProcessSerializer(many=True, read_only=True)
    
    class Meta:
        model = ProductTemplate
        fields = [
            # ... 现有字段 ...
            'process_items',  # ⭐新增
        ]
```

**文件**：`backend/apps/products/template_serializers.py` - `merge_template_data()`

```python
def merge_template_data(product_data, template):
    # ... 现有合并逻辑 ...
    
    # ⭐新增：合并工艺处理数据
    if template.process_items.exists():
        process_serializer = TemplateProcessSerializer(template.process_items.all(), many=True)
        process_data = process_serializer.data
        
        # 处理图片URL
        for item in process_data:
            if item.get('image'):
                item['image'] = request.build_absolute_uri(item['image'])
        
        # 如果产品没有工艺处理数据，使用模板数据
        if not product_data.get('process_items') or len(product_data.get('process_items', [])) == 0:
            product_data['process_items'] = process_data
    
    return product_data
```

---

### 步骤4：前端显示（可选）

**文件**：`frontend/src/pages/ProductDetail.tsx`

```typescript
// 显示工艺处理
{product.process_items && product.process_items.length > 0 && (
  <section className="process-section">
    <h2>工艺处理</h2>
    <div className="process-grid">
      {product.process_items.map((process, index) => (
        <div key={index} className="process-item">
          {process.image && (
            <img src={process.image} alt={process.name} />
          )}
          <h3>{process.name}</h3>
          <p>{process.description}</p>
        </div>
      ))}
    </div>
  </section>
)}
```

---

## 五、模板创建流程

### 5.1 创建完整模板的步骤

```
步骤1：进入后台 → 产品模板 → 添加产品模板

步骤2：填写基本信息
  - 模板名称：T-Slot铝型材标准模板
  - 关联分类：工业铝型材
  - 关联子分类：T-Slot铝型材

步骤3：填写基础参数
  - Range, Type, Surface Treatment, Colors, Grade, Temper

步骤4：⭐导入Excel规格表格
  - 点击"技术规格"区域的"导入Excel"按钮
  - 选择Excel文件（格式：A列=规格名称，B列=规格值）
  - 系统自动导入19行规格数据
  - 或手动逐条添加

步骤5：⭐添加工艺处理
  - 点击"添加工艺处理"
  - 添加多条工艺记录：
    - 工艺名称：阳极氧化
    - 工艺描述：详细的阳极氧化工艺说明...
    - 工艺图片：（上传图片）
    - 重复添加：粉末喷涂、电泳、木纹转印等

步骤6：⭐添加产品应用类型图片
  - 点击"添加应用领域"
  - 添加多条应用记录：
    - 应用名称：自动化设备框架
    - 应用描述：用于自动化设备...
    - 应用场景图片：（上传图片）
    - 重复添加：工作台、防护围栏等

步骤7：⭐添加工厂图片
  - 点击"添加工厂图片"
  - 添加多张工厂图片：
    - 图片标题：工厂外观
    - 图片分类：factory
    - 工厂图片：（上传图片）
    - 重复添加：生产车间、质量检测等

步骤8：填写其他内容
  - 产品描述、特性文本、包装详情
  - 商业信息

步骤9：保存模板
```

---

## 六、Excel导入功能详细设计

### 6.1 Excel文件格式

**标准格式**（2列）：
```
| 规格名称 (A列)          | 规格值 (B列)                          |
|------------------------|--------------------------------------|
| Material & Temper      | Aluminum 6063-T5/T6                  |
| Surface Treatment      | Mill Finished, Anodized, Powder...   |
| Colour                 | Silver, White, Black, Bronze...      |
| Film Standard          | 0.065mm PE film                      |
| Lifetime               | 20+ years                            |
| MOQ                    | 500kg                                |
| Length                 | Customized (Usually 1-6m)            |
| ...                    | ...                                  |
```

**可选格式**（3列，包含排序）：
```
| 规格名称 (A列) | 规格值 (B列) | 排序 (C列) |
|---------------|-------------|-----------|
| Material      | 6063-T5/T6  | 1         |
| Surface       | Anodized... | 2         |
| ...           | ...         | ...       |
```

---

### 6.2 导入功能实现

#### 方式1：内联编辑区域添加导入按钮（推荐）

**实现位置**：`TemplateSpecificationInline`

```python
class TemplateSpecificationInline(admin.TabularInline):
    model = TemplateSpecification
    extra = 1
    fields = ['name', 'value', 'order']
    ordering = ['order']
    
    # ⭐新增：添加导入按钮
    def get_formset(self, request, obj=None, **kwargs):
        formset = super().get_formset(request, obj, **kwargs)
        # 可以在这里添加自定义HTML
        return formset
```

**或者使用自定义模板**：
```python
class TemplateSpecificationInline(admin.TabularInline):
    # ... 现有代码 ...
    template = 'admin/products/template_specification_inline.html'  # 自定义模板
```

**自定义模板**：`backend/templates/admin/products/template_specification_inline.html`
```html
{% extends "admin/edit_inline/tabular.html" %}

{% block extrahead %}
{{ block.super }}
<script>
function importExcel() {
    // 打开Excel上传对话框
    // 调用导入API
}
</script>
{% endblock %}

{% block inline_field_sets %}
{{ block.super }}
<div class="excel-import-section">
    <button type="button" onclick="importExcel()">导入Excel规格表格</button>
    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display:none">
</div>
{% endblock %}
```

---

#### 方式2：在模板编辑页面添加导入按钮

**实现位置**：`ProductTemplateAdmin`

```python
@admin.register(ProductTemplate)
class ProductTemplateAdmin(admin.ModelAdmin):
    # ... 现有代码 ...
    
    def changeform_view(self, request, object_id=None, form_url='', extra_context=None):
        extra_context = extra_context or {}
        if object_id:
            extra_context['show_import_button'] = True
            extra_context['import_url'] = reverse('admin:products_template_import_specifications', args=[object_id])
        return super().changeform_view(request, object_id, form_url, extra_context)
```

**自定义模板**：`backend/templates/admin/products/producttemplate/change_form.html`
```html
{% extends "admin/change_form.html" %}

{% block submit_buttons_bottom %}
{{ block.super }}
{% if show_import_button %}
<div class="excel-import-section">
    <h3>批量导入</h3>
    <form method="post" action="{{ import_url }}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="excel_file" accept=".xlsx,.xls" required>
        <button type="submit">导入Excel规格表格</button>
    </form>
</div>
{% endif %}
{% endblock %}
```

---

## 七、数据库迁移

### 7.1 创建迁移文件

```bash
cd /www/wwwroot/Aluminum/backend
python manage.py makemigrations products --name add_template_process
python manage.py migrate
```

---

## 八、总结

### 8.1 模板打包内容

一个完整的模板包含：

1. **Excel表格（技术规格）**
   - ✅ 支持Excel导入批量添加
   - ✅ 支持手动逐条添加
   - ✅ 存储为 `TemplateSpecification[]`

2. **工艺处理描述**
   - ⭐新增：`TemplateProcess[]` 模型
   - 每条包含：工艺名称、描述、图片
   - 支持多种工艺（阳极氧化、粉末喷涂等）

3. **产品应用类型图片**
   - ✅ 已有：`TemplateApplication[]`
   - 每条包含：应用名称、描述、图片

4. **工厂图片**
   - ✅ 已有：`TemplateFactoryImage[]`
   - 每条包含：图片标题、描述、图片、分类

---

### 8.2 实施优先级

#### 优先级1：核心功能（必须）
1. ✅ 添加工艺处理模型（`TemplateProcess`）
2. ✅ 创建Excel导入功能
3. ✅ 更新序列化器和合并逻辑
4. ✅ 数据库迁移

**时间**：4-6小时

#### 优先级2：优化功能（建议）
1. ⚠️ 优化Excel导入UI
2. ⚠️ 添加导入验证和错误提示
3. ⚠️ 支持Excel模板下载

**时间**：2-3小时

---

### 8.3 关键优势

1. ✅ **Excel批量导入**：快速创建规格表格，无需逐条输入
2. ✅ **完整的工艺处理**：详细的工艺说明和图片展示
3. ✅ **统一管理**：所有模板内容集中管理
4. ✅ **灵活应用**：产品可以选择模板，自动应用所有内容

