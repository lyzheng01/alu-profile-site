{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .translation-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .translation-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .translation-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .translation-btn:hover {
      background: #0056b3;
    }
    .translation-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .logs-panel {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .status-success { background: #28a745; }
    .status-error { background: #dc3545; }
    .status-loading { background: #ffc107; }
    .status-idle { background: #6c757d; }
    .info-text {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      color: #0056b3;
    }
  </style>
{% endblock %}

{% block content %}
<div class="translation-panel">
  <h2>ğŸŒ ç¿»è¯‘ç®¡ç†ç³»ç»Ÿ</h2>
  
  <div class="info-text">
    <strong>ğŸ“ ç³»ç»Ÿè¯´æ˜ï¼š</strong><br>
    â€¢ é»˜è®¤è¯­è¨€ï¼šè‹±è¯­ (English)<br>
    â€¢ ç¿»è¯‘æ–¹å‘ï¼šè‹±è¯­ â†’ å…¶ä»–è¯­è¨€<br>
    â€¢ æ”¯æŒè¯­è¨€ï¼šä¸­æ–‡ã€è¥¿ç­ç‰™è¯­ã€è‘¡è„ç‰™è¯­ã€æ³•è¯­ã€å¾·è¯­ã€æ„å¤§åˆ©è¯­ã€ä¿„è¯­ã€æ—¥è¯­ã€éŸ©è¯­ã€é˜¿æ‹‰ä¼¯è¯­ã€å°åœ°è¯­<br>
    â€¢ ç¿»è¯‘ç­–ç•¥ï¼šé¢„ç¿»è¯‘ï¼Œé¿å…å®æ—¶ç¿»è¯‘å»¶è¿Ÿ
  </div>
  
  <div class="translation-buttons">
    <button class="translation-btn" onclick="translateFrontend()">
      ğŸ¨ ç¿»è¯‘å‰ç«¯å†…å®¹
    </button>
    <button class="translation-btn" onclick="translateProducts()">
      ğŸ“¦ ç¿»è¯‘äº§å“å†…å®¹
    </button>
    <button class="translation-btn" onclick="translateCategories()">
      ğŸ“‚ ç¿»è¯‘åˆ†ç±»å†…å®¹
    </button>
    <button class="translation-btn" onclick="translateArticles()">
      ğŸ“° ç¿»è¯‘èµ„è®¯å†…å®¹
    </button>
    <button class="translation-btn" onclick="translateAll()">
      ğŸš€ ç¿»è¯‘æ‰€æœ‰å†…å®¹
    </button>
    <button class="translation-btn" onclick="getLogs()">
      ğŸ“‹ æŸ¥çœ‹ç¿»è¯‘æ—¥å¿—
    </button>
  </div>
  
  <div id="status" style="margin-bottom: 10px;">
    <span class="status-indicator status-idle"></span>
    <span id="status-text">å°±ç»ª</span>
  </div>
  
  <div id="logs" class="logs-panel" style="display: none;">
    <div id="logs-content"></div>
  </div>
</div>

<script>
let isTranslating = false;

function updateStatus(status, text) {
  const statusEl = document.getElementById('status');
  const indicator = statusEl.querySelector('.status-indicator');
  const textEl = document.getElementById('status-text');
  
  indicator.className = 'status-indicator status-' + status;
  textEl.textContent = text;
}

function showLogs(logs) {
  const logsPanel = document.getElementById('logs');
  const logsContent = document.getElementById('logs-content');
  logsContent.textContent = logs;
  logsPanel.style.display = 'block';
}

function disableButtons() {
  const buttons = document.querySelectorAll('.translation-btn');
  buttons.forEach(btn => btn.disabled = true);
  isTranslating = true;
}

function enableButtons() {
  const buttons = document.querySelectorAll('.translation-btn');
  buttons.forEach(btn => btn.disabled = false);
  isTranslating = false;
}

async function makeTranslationRequest(url, actionName) {
  if (isTranslating) return;
  
  disableButtons();
  updateStatus('loading', `${actionName}ä¸­...`);
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    });
    
    const data = await response.json();
    
    if (data.success) {
      updateStatus('success', data.message);
      showLogs(data.logs || 'ç¿»è¯‘å®Œæˆï¼Œæ— è¯¦ç»†æ—¥å¿—');
    } else {
      updateStatus('error', data.message);
      showLogs('ç¿»è¯‘å¤±è´¥: ' + data.message);
    }
  } catch (error) {
    updateStatus('error', 'è¯·æ±‚å¤±è´¥');
    showLogs('è¯·æ±‚å¤±è´¥: ' + error.message);
  } finally {
    enableButtons();
  }
}

function translateFrontend() {
  makeTranslationRequest('{% url "admin:translate_frontend" %}', 'ç¿»è¯‘å‰ç«¯å†…å®¹');
}

function translateProducts() {
  makeTranslationRequest('{% url "admin:translate_products" %}', 'ç¿»è¯‘äº§å“å†…å®¹');
}

function translateCategories() {
  makeTranslationRequest('{% url "admin:translate_categories" %}', 'ç¿»è¯‘åˆ†ç±»å†…å®¹');
}

function translateArticles() {
  makeTranslationRequest('{% url "admin:translate_articles" %}', 'ç¿»è¯‘èµ„è®¯å†…å®¹');
}

function translateAll() {
  makeTranslationRequest('{% url "admin:translate_all" %}', 'ç¿»è¯‘æ‰€æœ‰å†…å®¹');
}

function getLogs() {
  makeTranslationRequest('{% url "admin:translation_logs" %}', 'è·å–æ—¥å¿—');
}

// é¡µé¢åŠ è½½æ—¶è·å–CSRF token
document.addEventListener('DOMContentLoaded', function() {
  // å¦‚æœæ²¡æœ‰CSRF tokenï¼Œåˆ›å»ºä¸€ä¸ªéšè—çš„input
  if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    document.body.appendChild(csrfInput);
  }
});
</script>

{% csrf_token %}
{% endblock %} 